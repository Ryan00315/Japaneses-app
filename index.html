<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JPNote-Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-flip { perspective: 1000px; }
        .card-inner { transition: transform 0.4s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .card-back { transform: rotateY(180deg); }
        .sticky-top { position: sticky; top: 0; z-index: 50; }
        ::-webkit-scrollbar { display: none; }
        .bg-glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10 font-sans text-slate-900">

    <div class="sticky-top bg-glass px-4 py-3 border-b border-slate-200">
        <div class="max-w-md mx-auto flex items-center gap-3">
            <div class="relative flex-1">
                <input type="text" id="searchInput" oninput="renderList()" placeholder="ğŸ” æœå°‹é›²ç«¯å–®å­—..." 
                       class="w-full p-3 rounded-2xl bg-slate-100 border-none outline-none focus:ring-2 ring-indigo-400 transition-all">
            </div>
            <div id="sync-status" class="flex flex-col items-center">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-gray-300"></div>
                <span class="text-[8px] mt-1 font-bold text-gray-400 uppercase">Cloud</span>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <header class="flex justify-between items-center mb-6 px-1">
            <h1 class="text-xl font-black text-indigo-600 tracking-tighter">NIHONGO CLOUD</h1>
            <button onclick="exportCSV()" class="text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-xl shadow-sm font-bold text-slate-600 active:scale-95 transition-all">åŒ¯å‡º CSV</button>
        </header>

        <div id="quiz-section" class="mb-8 hidden">
            <div class="card-flip h-56 w-full relative mb-4">
                <div id="quiz-card" onclick="this.classList.toggle('is-flipped')" class="card-inner w-full h-full shadow-2xl">
                    <div class="card-front bg-gradient-to-br from-indigo-600 to-indigo-700 text-white rounded-3xl flex flex-col items-center justify-center p-6 text-center">
                        <span id="quiz-q" class="text-5xl font-bold mb-4 tracking-wider"></span>
                        <button onclick="event.stopPropagation(); speak(document.getElementById('quiz-q').innerText)" 
                                class="bg-white/20 p-4 rounded-full hover:bg-white/30 transition-all">
                            <span class="text-2xl">ğŸ”Š</span>
                        </button>
                    </div>
                    <div class="card-back bg-white border-4 border-indigo-600 rounded-3xl flex flex-col items-center justify-center p-6 shadow-inner">
                        <p id="quiz-r" class="text-indigo-500 font-bold text-lg mb-2"></p>
                        <p id="quiz-a" class="text-3xl font-black text-slate-800"></p>
                    </div>
                </div>
            </div>
            <button onclick="loadRandomWord()" class="w-full py-4 bg-white border-2 border-indigo-600 text-indigo-600 rounded-2xl font-black shadow-lg active:scale-[0.98] transition-all">
                NEXT WORD
            </button>
        </div>

        <section class="bg-white rounded-3xl p-5 shadow-sm border border-slate-200 mb-6">
            <h3 class="text-xs font-bold text-slate-400 mb-3 ml-1">å¿«é€ŸåŒæ­¥æ–°å–®å­—</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input id="word" type="text" placeholder="å–®å­—" class="bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 ring-indigo-300 transition-all">
                <input id="reading" type="text" placeholder="å‡å" class="bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 ring-indigo-300 transition-all">
            </div>
            <input id="meaning" type="text" placeholder="ä¸­æ–‡æ„æ€" class="w-full bg-slate-50 p-4 rounded-2xl mb-4 outline-none focus:ring-2 ring-indigo-300 transition-all">
            <button onclick="addWordToCloud()" id="addBtn" 
                    class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all shadow-xl shadow-slate-200 active:scale-[0.98] disabled:opacity-50">
                åŒæ­¥åˆ°é›²ç«¯è³‡æ–™åº«
            </button>
        </section>

        <div class="flex items-center justify-between mb-4 px-1">
            <h2 class="font-bold text-slate-700">æˆ‘çš„å­—åº«</h2>
            <span id="count-badge" class="text-[10px] font-bold bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">0 Words</span>
        </div>
        <ul id="vocab-list" class="space-y-3"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ é‡è¦ï¼šè«‹åœ¨æ­¤è™•æ›¿æ›ç‚ºä½ è‡ªå·±çš„ Firebase Config
        const firebaseConfig = {
  apiKey: "AIzaSyDOsqjX7FknZOKTdEUiofhIwIwGVRUIdN4",
  authDomain: "jpnote-5f436.firebaseapp.com",
  projectId: "jpnote-5f436",
  storageBucket: "jpnote-5f436.firebasestorage.app",
  messagingSenderId: "881660892658",
  appId: "1:881660892658:web:9d88f9b2332aa9e2b3076b",
  measurementId: "G-QV2NRXQSY7"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const vocabsCol = collection(db, "vocabs");

        window.vocabs = [];

        // 1. ç›£è½é›²ç«¯è³‡æ–™ (å³æ™‚åŒæ­¥)
        const q = query(vocabsCol, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            window.vocabs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderList();
            updateQuizUI();
            document.getElementById('status-dot').classList.replace('bg-gray-300', 'bg-green-500');
        }, (error) => {
            console.error("Firebase é€£ç·šå¤±æ•—:", error);
            document.getElementById('status-dot').classList.replace('bg-gray-300', 'bg-red-500');
        });

        // 2. æ–°å¢å–®å­— (å«é‡è¤‡æª¢æŸ¥)
        window.addWordToCloud = async () => {
            const w = document.getElementById('word');
            const r = document.getElementById('reading');
            const m = document.getElementById('meaning');
            const btn = document.getElementById('addBtn');

            const wordValue = w.value.trim();
            const meaningValue = m.value.trim();

            if (!wordValue || !meaningValue) return alert("è«‹å¡«å¯«å–®å­—èˆ‡æ„æ€");

            // --- é‡è¤‡åµæ¸¬ ---
            const isDuplicate = window.vocabs.some(v => v.word === wordValue);
            if (isDuplicate) {
                const confirmAdd = confirm(`âš ï¸ å–®å­—ã€Œ${wordValue}ã€å·²åœ¨è³‡æ–™åº«ä¸­ã€‚\næ˜¯å¦ä»è¦æ–°å¢ï¼Ÿ`);
                if (!confirmAdd) return;
            }

            btn.disabled = true;
            btn.innerText = "åŒæ­¥ä¸­...";

            try {
                await addDoc(vocabsCol, {
                    word: wordValue,
                    reading: r.value.trim(),
                    meaning: meaningValue,
                    category: "æœªåˆ†é¡",
                    createdAt: new Date()
                });
                w.value = ''; r.value = ''; m.value = '';
            } catch (e) {
                alert("åŒæ­¥å¤±æ•—: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "åŒæ­¥åˆ°é›²ç«¯è³‡æ–™åº«";
            }
        };

        // 3. åˆªé™¤å–®å­—
        window.deleteWord = async (id) => {
            if (!confirm("ç¢ºå®šè¦å¾é›²ç«¯æ°¸ä¹…åˆªé™¤æ­¤å–®å­—å—ï¼Ÿ")) return;
            try {
                await deleteDoc(doc(db, "vocabs", id));
            } catch (e) {
                alert("åˆªé™¤å¤±æ•—");
            }
        };
    </script>

    <script>
        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const listEl = document.getElementById('vocab-list');
            const countBadge = document.getElementById('count-badge');
            
            const filtered = (window.vocabs || []).filter(v => 
                v.word.includes(search) || v.meaning.includes(search) || v.reading.includes(search)
            );
            
            countBadge.innerText = `${filtered.length} Words`;

            listEl.innerHTML = filtered.map(v => `
                <li class="bg-white p-5 rounded-3xl flex justify-between items-center shadow-sm border border-slate-100 transition-all active:bg-slate-50">
                    <div>
                        <div class="text-xl font-bold text-slate-800">${v.word} <span class="text-xs font-normal text-slate-400 ml-1">ã€${v.reading}ã€‘</span></div>
                        <div class="text-slate-500 text-sm font-medium mt-1">${v.meaning}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="speak('${v.word}')" class="w-12 h-12 flex items-center justify-center bg-slate-50 rounded-2xl text-slate-400 hover:text-indigo-500 transition-colors text-xl">ğŸ”Š</button>
                        <button onclick="deleteWord('${v.id}')" class="w-12 h-12 flex items-center justify-center text-slate-200 hover:text-red-400 transition-colors text-xl">âœ•</button>
                    </div>
                </li>
            `).join('');
        }

        function speak(text) {
            if (!text) return;
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            
            // å°‹æ‰¾æœ€ä½³å¥³è²
            const femaleVoice = voices.find(v => v.lang.includes('ja') && (v.name.includes('Google') || v.name.includes('Nanami') || v.name.includes('Kyoko')));
            
            uttr.voice = femaleVoice || voices.find(v => v.lang.includes('ja'));
            uttr.lang = 'ja-JP';
            uttr.rate = 0.85;
            uttr.pitch = 1.15; // ç¨å¾®æé«˜éŸ³èª¿æ¨¡æ“¬è‡ªç„¶å¥³è²
            window.speechSynthesis.speak(uttr);
        }

        let currentQuizWord = null;
        function updateQuizUI() {
            const section = document.getElementById('quiz-section');
            if (window.vocabs && window.vocabs.length > 0) {
                section.classList.remove('hidden');
                if (!currentQuizWord) loadRandomWord();
            } else {
                section.classList.add('hidden');
            }
        }

        function loadRandomWord() {
            document.getElementById('quiz-card').classList.remove('is-flipped');
            if (!window.vocabs || window.vocabs.length === 0) return;
            
            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * window.vocabs.length);
                currentQuizWord = window.vocabs[randomIndex];
                document.getElementById('quiz-q').innerText = currentQuizWord.word;
                document.getElementById('quiz-r').innerText = currentQuizWord.reading;
                document.getElementById('quiz-a').innerText = currentQuizWord.meaning;
            }, 150);
        }

        function exportCSV() {
            if (!window.vocabs || window.vocabs.length === 0) return alert("ç›®å‰æ²’æœ‰å–®å­—å¯ä»¥åŒ¯å‡º");
            const header = "\uFEFFå–®å­—,è®€éŸ³,æ„æ€\n";
            const rows = window.vocabs.map(v => `"${v.word}","${v.reading}","${v.meaning}"`).join("\n");
            const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `æ—¥æ–‡å–®å­—å‚™ä»½_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // åˆå§‹åŒ–èªéŸ³è¼‰å…¥
        window.speechSynthesis.getVoices();
    </script>
</body>
</html>
