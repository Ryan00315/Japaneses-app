<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æ–‡é›²ç«¯å–®å­—æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIXME: è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Firebase å°ˆæ¡ˆè¨­å®š
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };

        // åˆå§‹åŒ– Firebase (è‹¥æ²’å¡«è¨­å®šæœƒè·‘ Local æ¨¡å¼)
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            console.log("Cloud Mode Enabled");
        }
    </script>
    <style>
        .card-flip { perspective: 1000px; }
        .card-inner { transition: transform 0.4s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .card-back { transform: rotateY(180deg); }
        .active-filter { background-color: #4f46e5 !important; color: white !important; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 pb-10 font-sans">

    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-indigo-600">æ—¥æ–‡é›²ç«¯ç­†è¨˜</h1>
            <div class="flex gap-2">
                <button onclick="exportCSV()" class="text-xs bg-white border px-2 py-1 rounded shadow-sm hover:bg-gray-50">åŒ¯å‡º</button>
                <label class="text-xs bg-indigo-50 border border-indigo-200 px-2 py-1 rounded shadow-sm cursor-pointer hover:bg-indigo-100">
                    åŒ¯å…¥ <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importCSV(event)">
                </label>
            </div>
        </header>

        <div id="quiz-section" class="mb-8 hidden">
            <div class="card-flip h-52 w-full relative mb-4">
                <div id="quiz-card" onclick="this.classList.toggle('is-flipped')" class="card-inner w-full h-full shadow-xl">
                    <div class="card-front bg-indigo-600 text-white rounded-3xl flex flex-col items-center justify-center p-6 text-center">
                        <span id="quiz-q" class="text-5xl font-bold mb-2"></span>
                        <button onclick="event.stopPropagation(); speak(document.getElementById('quiz-q').innerText)" class="mt-2 bg-indigo-500 p-2 rounded-full hover:bg-indigo-400 transition">ğŸ”Š</button>
                    </div>
                    <div class="card-back bg-white border-4 border-indigo-600 rounded-3xl flex flex-col items-center justify-center p-6 shadow-inner">
                        <p id="quiz-r" class="text-indigo-400 font-bold mb-1"></p>
                        <p id="quiz-a" class="text-3xl font-black text-slate-800"></p>
                    </div>
                </div>
            </div>
            <button onclick="loadRandomWord()" class="w-full py-3 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition">ä¸‹ä¸€é¡Œ</button>
        </div>

        <section class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 mb-6">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input id="word" type="text" placeholder="å–®å­—" class="bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-indigo-300">
                <input id="reading" type="text" placeholder="è®€éŸ³" class="bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-indigo-300">
            </div>
            <input id="meaning" type="text" placeholder="ä¸­æ–‡æ„æ€" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none focus:ring-2 ring-indigo-300">
            <div class="flex gap-3">
                <select id="category" class="bg-gray-50 px-4 rounded-xl text-sm font-bold text-gray-500">
                    <option>åè©</option>
                    <option>å‹•è©</option>
                    <option>å½¢å®¹è©</option>
                </select>
                <button onclick="addWord()" class="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">æ–°å¢</button>
            </div>
        </section>

        <div class="sticky top-0 bg-gray-50 pt-2 pb-4 z-10">
            <input type="text" id="searchInput" oninput="renderList()" placeholder="æœå°‹å–®å­—..." class="w-full p-4 rounded-2xl bg-white shadow-sm border border-gray-100 mb-3">
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="setFilter('å…¨éƒ¨')" class="filter-btn active-filter px-5 py-2 rounded-full bg-white border text-sm font-bold shadow-sm">å…¨éƒ¨</button>
                <button onclick="setFilter('åè©')" class="filter-btn px-5 py-2 rounded-full bg-white border text-sm font-bold shadow-sm">åè©</button>
                <button onclick="setFilter('å‹•è©')" class="filter-btn px-5 py-2 rounded-full bg-white border text-sm font-bold shadow-sm">å‹•è©</button>
                <button onclick="setFilter('å½¢å®¹è©')" class="filter-btn px-5 py-2 rounded-full bg-white border text-sm font-bold shadow-sm">å½¢å®¹è©</button>
            </div>
        </div>

        <ul id="vocab-list" class="space-y-3"></ul>
    </div>

    <script>
        let vocabs = JSON.parse(localStorage.getItem('myVocabsV3')) || [];
        let currentFilter = 'å…¨éƒ¨';
        let currentQuizWord = null;

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        function addWord() {
            const data = {
                word: document.getElementById('word').value,
                reading: document.getElementById('reading').value,
                meaning: document.getElementById('meaning').value,
                category: document.getElementById('category').value,
                id: Date.now()
            };
            if (!data.word || !data.meaning) return alert("å…§å®¹ä¸èƒ½ç‚ºç©º");
            
            vocabs.push(data);
            saveData();
            ['word', 'reading', 'meaning'].forEach(id => document.getElementById(id).value = '');
        }

        function saveData() {
            localStorage.setItem('myVocabsV3', JSON.stringify(vocabs));
            renderList();
            renderQuizUI();
        }

        // --- åŒ¯å…¥/åŒ¯å‡º (Excel CSV) ---
        function exportCSV() {
            const header = "\uFEFFå–®å­—,è®€éŸ³,æ„æ€,åˆ†é¡\n"; // \uFEFF è§£æ±º Excel ä¸­æ–‡äº‚ç¢¼
            const rows = vocabs.map(v => `${v.word},${v.reading},${v.meaning},${v.category}`).join("\n");
            const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "æ—¥æ–‡å–®å­—æœ¬.csv";
            link.click();
        }

        function importCSV(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split("\n").slice(1); // è·³éæ¨™é¡Œåˆ—
                lines.forEach(line => {
                    const [word, reading, meaning, category] = line.split(",");
                    if (word && meaning) {
                        vocabs.push({ word: word.trim(), reading: reading.trim(), meaning: meaning.trim(), category: category.trim() || 'æœªåˆ†é¡', id: Date.now() + Math.random() });
                    }
                });
                saveData();
                alert("åŒ¯å…¥å®Œæˆï¼");
            };
            reader.readAsText(file);
        }

        // --- è‡ªç„¶ç™¼éŸ³ (TTS) ---
        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            // æŒ‘é¸æœ€ä½³æ—¥æ–‡è²éŸ³
            uttr.voice = voices.find(v => v.lang === 'ja-JP' && v.name.includes('Google')) || 
                         voices.find(v => v.lang === 'ja-JP');
            uttr.lang = 'ja-JP';
            uttr.rate = 0.8;
            window.speechSynthesis.speak(uttr);
        }

        // --- UI æ¸²æŸ“èˆ‡ç¯©é¸ ---
        function setFilter(cat) {
            currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active-filter', btn.innerText === cat));
            renderList();
        }

        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const listEl = document.getElementById('vocab-list');
            const filtered = vocabs.filter(v => (currentFilter === 'å…¨éƒ¨' || v.category === currentFilter) && (v.word.includes(search) || v.meaning.includes(search)));
            
            listEl.innerHTML = filtered.map(v => `
                <li class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-100">
                    <div>
                        <span class="text-[10px] font-black text-indigo-400 uppercase">${v.category}</span>
                        <div class="text-xl font-bold text-gray-800">${v.word} <span class="text-xs font-normal text-gray-400">ã€${v.reading}ã€‘</span></div>
                        <div class="text-gray-500 text-sm font-medium">${v.meaning}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="speak('${v.word}')" class="text-gray-300 hover:text-indigo-500 transition">ğŸ”Š</button>
                        <button onclick="deleteWord(${v.id})" class="text-gray-300 hover:text-red-500 transition">âœ•</button>
                    </div>
                </li>
            `).reverse().join('');
        }

        function loadRandomWord() {
            document.getElementById('quiz-card').classList.remove('is-flipped');
            const pool = currentFilter === 'å…¨éƒ¨' ? vocabs : vocabs.filter(v => v.category === currentFilter);
            if (pool.length === 0) return;
            setTimeout(() => {
                currentQuizWord = pool[Math.floor(Math.random() * pool.length)];
                document.getElementById('quiz-q').innerText = currentQuizWord.word;
                document.getElementById('quiz-r').innerText = currentQuizWord.reading;
                document.getElementById('quiz-a').innerText = currentQuizWord.meaning;
            }, 150);
        }

        function renderQuizUI() {
            const section = document.getElementById('quiz-section');
            if (vocabs.length > 0) {
                section.classList.remove('hidden');
                if (!currentQuizWord) loadRandomWord();
            } else {
                section.classList.add('hidden');
            }
        }

        function deleteWord(id) {
            vocabs = vocabs.filter(v => v.id !== id);
            saveData();
        }

        // å•Ÿå‹•èªéŸ³ç³»çµ± (éƒ¨åˆ†ç€è¦½å™¨éœ€è¦å…ˆäº¤äº’)
        window.speechSynthesis.getVoices();
        saveData();
    </script>
</body>
</html>